// BrowserMobProxyInKatalonStudio/Test Cases/prostprocess/select_entries-jquery.min.js

import static com.kms.katalon.core.testcase.TestCaseFactory.findTestCase

import java.nio.file.Files
import java.nio.file.Path
import java.nio.file.Paths
import java.util.regex.Pattern

import com.jayway.jsonpath.Criteria
import com.jayway.jsonpath.Filter
import com.jayway.jsonpath.JsonPath
import com.kms.katalon.core.configuration.RunConfiguration
import com.kms.katalon.core.webui.keyword.WebUiBuiltInKeywords as WebUI

/**
 * BrowserobProxyInKatalonStudio/Test Cases/transform_HAR_for_jquery.min.js
 * 
 * 
 * @author kazurayam
 */
// Input
Path projectDir = Paths.get(RunConfiguration.getProjectDir());
Path inputHar = projectDir.resolve("work/sample.har")

// specifeis how we use Jayway JsonPath to transform the input HAR
Closure cls = { Path har ->
	
	// I am solely interested in a HTTP request of which URL contains a string ".jquery.min.js"
	Filter filter = Filter.filter(
		Criteria.where("request.url")
				.regex(Pattern.compile('.*jquery\\.min\\.js')));
	
	// Now extract interesting portion out of HAR!
	List<Map<String, Object>> result =
		JsonPath.parse(Files.newInputStream(har))
			.read("\$['log']['entries'][?]", filter)
									// [?(...)] is a filter expression
	return result
	
	// see https://www.baeldung.com/guide-to-jayway-jsonpath for more about Jayway JsonPath
}

// Output
Path output = projectDir.resolve("work/jquery.min.js.json")
Files.createDirectories(output.getParent())

// apply the templates which drive Jayway JsonPath
WebUI.callTestCase(findTestCase("Test Cases/postprocess/HARTransformer"),
					[
						"inputHar": inputHar,
						"templates": cls,
						"outputJson": output
					])
