import java.nio.file.Files
import java.nio.file.Path
import java.nio.file.Paths
import java.util.regex.Pattern

import com.jayway.jsonpath.Criteria
import com.jayway.jsonpath.Filter
import com.jayway.jsonpath.JsonPath
import com.kazurayam.ks.HarTransformer
import com.kms.katalon.core.configuration.RunConfiguration

/**
 * BrowserobProxyInKatalonStudio/Test Cases/transform_HAR_for_jquery.min.js
 * 
 * 
 * @author kazurayam
 */
// Input
Path projectDir = Paths.get(RunConfiguration.getProjectDir());
Path HAR = projectDir.resolve("work/sample.har")

// specifeis how we use Jayway JsonPath to transform the input HAR
Closure templates = { Path har ->
	// I am solely interested in a HTTP request of which URL contains a string ".jquery.min.js"
	Filter filter = Filter.filter(
		Criteria.where("request.url")
				.regex(Pattern.compile('.*jquery\\.min\\.js')));
	
	// Now extract interesting portion out of HAR!
	List<Map<String, Object>> squeezed =
		JsonPath.parse(Files.newInputStream(har))
			.read("\$['log']['entries'][?]", filter)
									// [?(...)] is a filter expression
	return squeezed
}

// Output
Path result = projectDir.resolve("work/jquery.min.js.json")
Files.createDirectories(result.getParent())

// apply the templates which drive Jayway JsonPath
HarTransformer.applyTemplates(HAR, templates, result)